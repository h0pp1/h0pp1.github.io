---
title: '[Mobile] InjuredAndroid Writeup-2'
author: hoppi
date: 2023-01-22 11:36:00 + 0000
categories: [Mobile]
tags: [mobile, deeplink, file_provider]
---
[ì§€ë‚œ ê¸€](https://h0pp1.github.io/posts/injured/)ì— ì´ì–´ì„œ ì ì–´ë³´ë„ë¡ í•˜ê² ë‹¤.
<br/>

# DeepLink
***
AndroidManifest.xml íŒŒì¼ì„ ë³´ë©´ schemeì´ `flag11`ì¸ ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  
![manifest](../../../assets/img/2023-01-22/manifest.png){: w="800" h="400" }  
<br/>

ì•„ë˜ì™€ ê°™ì´ `data.getScheme()` ì´ `flag11`ì´ ì•„ë‹ˆë©´ í•´ë‹¹ ì—‘í‹°ë¹„í‹°ë¥¼ ë³¼ ìˆ˜ ì—†ë‹¤.  
```java
//DeepLinkActivity: 132

@Override // androidx.appcompat.app.c, androidx.fragment.app.d, androidx.activity.ComponentActivity, androidx.core.app.e, android.app.Activity
    public void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        setContentView(R.layout.activity_deep_link);
        j.j.a(this);
        Intent intent = getIntent();
        d.s.d.g.d(intent, "intentToUri");
        Uri data = intent.getData();
        if (d.s.d.g.a("flag11", data != null ? data.getScheme() : null)) {
            startActivity(new Intent("android.intent.action.VIEW"));
        }
        ((FloatingActionButton) findViewById(R.id.fab)).setOnClickListener(new a());
    }
```
{: file="DeepLinkActivity"}
<br/>

`am` ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ ë”¥ë§í¬ë¥¼ ì„¤ì •í•´ì¤€ë‹¤.  
```zsh
am start -W -a android.intent.action.VIEW -d "flag11://"
```
<br/>

ê·¸ëŸ¬ë©´ í”Œë ˆê·¸ë¥¼ ì…ë ¥í•˜ëŠ” í™”ë©´ì´ ë‚˜ì˜¤ê³  íŒíŠ¸ë¥¼ ë³´ë©´ `Find the complied treasure` ì´ë¼ê³  í•œë‹¤. resources/assets/ ì—ì„œ `meÅ‰u` ë¼ëŠ” ë°”ì´ë„ˆë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ìˆê³  ë¡œì»¬ì—ì„œ í™•ì¸í•˜ê¸° ìœ„í•´ `jadx` ëª…ë ¹ì–´ë¡œ ë””ì»´íŒŒì¼ í•´ì¤€ë‹¤.(apkíŒŒì¼ì„ unzip í–ˆì„ ë•Œ í•´ë‹¹ ë°”ì´ë„ˆë¦¬ê°€ ë³´ì´ì§€ ì•Šì•˜ë‹¤.)  
```zsh
jadx ./b3nac.injuredandroid.apk
```
<br/>

ì—¬ê¸°ì„œ ë¬¸ì œì ì€ í°ì´ë‚˜ ì»´í“¨í„°ë‚˜ arm ê¸°ë°˜ì´ë¼ì„œ ë°”ì´ë„ˆë¦¬ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•„ í”Œë ˆê·¸ë¥¼ ë³¼ ìˆ˜ ì—†ì—ˆë‹¤. ã…‹ã…‹ã…‹ã…‹ ì‹¬ì§€ì–´ í”Œë ˆê·¸ê°€ ì¼ì •í•œ í¬ë©§ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ì ˆëŒ€ë¡œ `strings` ëª…ë ¹ì–´ë¡œë„ ê²Œì‹±ì¡°ì°¨ í•  ìˆ˜ ì—†ë‹¤. ì•„ë¬´íŠ¼ í™˜ê²½ì— ë§ì¶°ì„œ ë°”ì´ë„ˆë¦¬ë¥¼ ì‹¤í–‰í•˜ë©´ ëœë‹¤. í”Œë ˆê·¸ëŠ” `HIIMASTRING` ì´ë‹¤.  
<br/>

# Protected components
***
ExportedProtectedIntent í´ë˜ìŠ¤ì—ì„œ ì•„ë˜ì™€ ê°™ì´ `getParcelableExtra()`ë¥¼ í†µí•´ì„œ `intent` ê°ì²´ë¥¼ ë°›ì•„ì˜¨ë‹¤. ê·¸ë¦¬ê³  íŒ¨í‚¤ì§€ ì´ë¦„ì´ b3nac.injuredandroid ì´ë©´ ì—‘í‹°ë¹„í‹°ë¥¼ ì‹¤í–‰ì‹œí‚¨ë‹¤.(getParcelableExtra(String)ì€ í˜„ì¬ deprecated)  
```java
//ExportedProtectedIntent: 12

...

private void F(Intent intent) {
        Intent intent2 = (Intent) intent.getParcelableExtra("access_protected_component");
        if (intent2.resolveActivity(getPackageManager()).getPackageName().equals("b3nac.injuredandroid")) {
            startActivity(intent2);
        }
    }
```
{: file='ExportedProtectedIntent'}
<br/>

FlagTwelveProtectedActivity í´ë˜ìŠ¤ì—ì„œëŠ” `getStringExtra()`ë¥¼ í†µí•´ì„œ ë¬¸ìì—´ ê°’ì„ ë°›ì•„ì˜¨ë‹¤. ë¶„ê¸°ë¬¸ì„ ë³´ë©´ ê°’ì˜ schemeì´ https ì´ì–´ì•¼ í”Œë ˆê·¸ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.  
```java
public final class FlagTwelveProtectedActivity extends androidx.appcompat.app.c {
    private final void F() {
        startActivity(new Intent(this, FlagOneSuccess.class));
    }

    @Override // androidx.appcompat.app.c, androidx.fragment.app.d, androidx.activity.ComponentActivity, androidx.core.app.e, android.app.Activity
    public void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        WebView webView = new WebView(this);
        setContentView(webView);
        j.j.a(this);
        C((Toolbar) findViewById(R.id.toolbar));
        Uri parse = Uri.parse(getIntent().getStringExtra("totally_secure"));
        WebSettings settings = webView.getSettings();
        d.s.d.g.d(settings, "flagWebView.settings");
        settings.setJavaScriptEnabled(true);
        webView.setWebChromeClient(new WebChromeClient());
        if (getIntent() == null || !getIntent().hasExtra("totally_secure")) {
            finish();
            return;
        }
        d.s.d.g.d(parse, "uri");
        if (!d.s.d.g.a("https", parse.getScheme())) {
            webView.loadData(getIntent().getStringExtra("totally_secure"), "text/html", "UTF-8");
            return;
        }
        FlagsOverview.K = true;
        j jVar = new j();
        Context applicationContext = getApplicationContext();
        d.s.d.g.d(applicationContext, "applicationContext");
        jVar.b(applicationContext, "flagTwelveButtonColor", true);
        F();
    }
}
```
{: file='FlagTwelveProtectedActivity'}                                          
<br/>

ì´ê±´ ëª°ë¼ì„œ ë¡¸ì—…ì„ ë´¤ëŠ”ë° PoC ì•±ì„ í•˜ë‚˜ ë§Œë“¤ì–´ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ í–ˆë‹¤. í•˜ì§€ë§Œ PoC ì½”ë“œë¥¼ ë³´ë‹ˆ startActivityë¥¼ í›„í‚¹í•˜ì—¬ ë‚´ê°€ ì˜ë„í•˜ëŠ” intentë¥¼ ì „ë‹¬í•´ì£¼ë©´ ê°€ëŠ¥í•  ê²ƒ ê°™ì•„ì„œ fridaë¡œ í•´ë´¤ëŠ”ë° ì •ìƒì ìœ¼ë¡œ í”Œë ˆê·¸ë¥¼ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤.  
ì°¸ê³ ë¡œ `setClassName()`ì„ í†µí•´ì„œ <u>ë‹¤ë¥¸ Applicationì˜ ì—‘í‹°ë¹„í‹°ë¥¼ call í•  ìˆ˜ ìˆë‹¤.</u> ë”°ë¼ì„œ PoC ì•±ì´ ê°€ëŠ¥í•œ ì´ìœ ëŠ” `ExportedProtectedIntent`ì— í•´ë‹¹í•˜ëŠ” activity ì»´í¬ë„ŒíŠ¸ê°€ `exported='true'`ë¡œ ì„¤ì •ë˜ì–´ìˆê¸° ë•Œë¬¸ì´ë‹¤.  
ë§Œì•½ ë¬´ìŠ¨ë§ì¸ì§€ ëª¨ë¥´ê² ë‹¤ë©´ [ì—¬ê¸°](https://boanit.github.io/pen/android_exported_true.html)ë¥¼ ì½ì–´ë³´ì.  
```javascript
function hookStartActivity(){
    var Activity = Java.use("android.app.Activity")
    var intent = Java.use("android.content.Intent");
    Activity.startActivity.overload('android.content.Intent').implementation=function(a1){
        var instance = intent.$new();
        var instance2 = intent.$new();
        instance.setClassName('b3nac.injuredandroid','b3nac.injuredandroid.FlagTwelveProtectedActivity');
        instance.putExtra('totally_secure','https://asd.com');
        instance2.setClassName('b3nac.injuredandroid','b3nac.injuredandroid.ExportedProtectedIntent');
        instance2.putExtra('access_protected_component',instance);
        return this.startActivity(instance2);
    }
}
```
<br/>

# RCE
***
ì´ë²ˆì—ë„ ë”¥ë§í¬ë¥¼ ì´ìš©í•œë‹¤.  
![deeplink](../../../assets/img/2023-01-22/deeplink.png){: w="800" h="400" }  
<br/>

RCEActivityì—ì„œ onCreate ë¶€ë¶„ì„ ë³´ë©´ ì´ 3ê°œì˜ íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤. `queryParameter3`ì´ nullì´ë©´ `binary`, `param` íŒŒë¼ë¯¸í„°ë¥¼ í†µí•´ì„œ íŠ¹ì • ìœ„ì¹˜ì— ìˆëŠ” ë°”ì´ë„ˆë¦¬ íŒŒì¼ì— ì¸ìë¥¼ ì£¼ê³  ì‹¤í–‰í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.  
```java
//RCEActivity: 267

public void onCreate(Bundle bundle) {
        super.onCreate(bundle);
        setContentView(R.layout.activity_rce);
        j.j.a(this);
        C((Toolbar) findViewById(R.id.toolbar));
        G();
        ((FloatingActionButton) findViewById(R.id.fab)).setOnClickListener(new a());
        if (getIntent() != null) {
            Intent intent = getIntent();
            d.s.d.g.d(intent, "intent");
            if (intent.getData() != null) {
                H();
                Intent intent2 = getIntent();
                d.s.d.g.d(intent2, "intent");
                Uri data = intent2.getData();
                try {
                    d.s.d.g.c(data);
                    String queryParameter = data.getQueryParameter("binary");
                    String queryParameter2 = data.getQueryParameter("param");
                    String queryParameter3 = data.getQueryParameter("combined");
                    if (queryParameter3 != null) {
                        this.x.b(new b(queryParameter3));
                    } else {
                        Runtime runtime = Runtime.getRuntime();
                        StringBuilder sb = new StringBuilder();
                        File filesDir = getFilesDir();
                        d.s.d.g.d(filesDir, "filesDir");
                        sb.append(filesDir.getParent());
                        sb.append("/files/");
                        sb.append(queryParameter);
                        sb.append(" ");
                        sb.append(queryParameter2);
                        Process exec = runtime.exec(sb.toString());
                        d.s.d.g.d(exec, "process");
                        BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(exec.getInputStream()));
                        StringBuilder sb2 = new StringBuilder();
                        d.r.c.a(bufferedReader, new c(sb2));
                        exec.waitFor();
                        TextView textView = (TextView) findViewById(R.id.RCEView);
                        d.s.d.g.d(textView, "tv");
                        textView.setText(sb2.toString());
                    }
                } catch (IOException e) {
                    Log.e("RCEActivity", "OH NO AN ERROR OCCURED!!!:" + e.getMessage());
                }
            }
        }
    }
```
{: file='RCEActivity'}
<br/>

`filesDir`ì„ ì •í™•í•˜ê²Œ ì•Œê¸° ìœ„í•´ì„œ `d.s.d.g.d`ë¥¼ í›„í‚¹í•´ë³´ë‹ˆ `/data/user/0/b3nac.injuredandroid/files` ì˜€ë‹¤.  
![filesdir](../../../assets/img/2023-01-22/filesdir.png){: w="600" h="300" }  
<br/>

í•´ë‹¹ ê²½ë¡œë¡œ ê°€ë³´ë©´ ì´ 3ê°œì˜ ë°”ì´ë„ˆë¦¬ê°€ ì¡´ì¬í–ˆë‹¤. menuëŠ” ì´ë¯¸ ì•ì—ì„œ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì— `narnia`ë¥¼ ëˆˆì—¬ê²¨ ë³´ì•˜ë‹¤.  
![binaries](../../../assets/img/2023-01-22/binaries.png){: w="600" h="300" }  
<br/>

í•¸ë“œí°ì— ë§ëŠ” `narnia.arm64`ì— ì‹¤í–‰ê¶Œí•œì„ ì£¼ê³  ì‹¤í–‰í–ˆëŠ”ë° íŒŒë¼ë¯¸í„°ê°€ í•„ìš”í•˜ë‹¤ê³  ë‚˜ì˜¨ë‹¤.  
![narnia](../../../assets/img/2023-01-22/narnia.png){: w="600" h="300" }  
<br/>

`--help`ë¥¼ ì…ë ¥í•˜ë©´ ì“¸ ìˆ˜ ìˆëŠ” ì¸ì ê°’ë“¤ì´ ë‚˜ì˜¨ë‹¤. (ì ì  ê²Œì‹±ì„ ìš”êµ¬í•œë‹¤)  
![help](../../../assets/img/2023-01-22/help.png){: w="600" h="300" }  
<br/>

testOne, testTwo, testThreeë¥¼ ê°ê° ì¸ì ê°’ìœ¼ë¡œ ì£¼ë©´ `Treasure`, `_`,  `Planet`ì´ ë‚˜ì˜¨ë‹¤.   
ì´ ì…‹ì„ ì¡°í•©í•˜ë©´ `Treasure_Planet`ì´ ëœë‹¤.
ì´ê±¸ `combined` íŒŒë¼ë¯¸í„°ì— ë„£ê³  ì „ì†¡í•˜ë©´ ëë‚œë‹¤. (ë£¨íŒ…ëœ ë‹¨ë§ê¸°ì´ê¸° ë•Œë¬¸ì— êµ³ì´ ë”¥ë§í¬ë¡œ ëª…ë ¹ì–´ë¥¼ ë‚ ë¦¬ë©´ì„œ í™•ì¸í•  í•„ìš”ê°€ ì—†ì—ˆë‹¤. ì—ë®¬ë„ ë§ˆì°¬ê°€ì§€ê² ì§€ë§Œ)  
```zsh
am start -W -a android.intent.action.VIEW -d "flag13://rce?combined=Treasure_Planet"
```
<br/>

# Assembly
***
AssemblyActivity í´ë˜ìŠ¤ì—ì„œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë‹¨ì—ì„œ `stringFromJNI()` í˜¸ì¶œí•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.  
```java
//AssemblyActivity

...

static {
        System.loadLibrary("native-lib");
    }

...

public final native String stringFromJNI();
```
{: file='AssemblyActivity'}
<br/>

`ida`ì—ì„œ í•´ë‹¹ í•¨ìˆ˜ë¥¼ ê²€ìƒ‰í•˜ì—¬ ë³´ë©´ ì…ë ¥ ê°’(í”Œë ˆê·¸)ì„ ë°”ë¡œ ì°¾ì„ ìˆ˜ ìˆë‹¤.  
![win](../../../assets/img/2023-01-22/win.png){: w="600" h="300" }  
<br/>

# File Provider
***
`AndroidManifest.xml` íŒŒì¼ì—ì„œ FlagEighteenActivityì— í•´ë‹¹í•˜ëŠ” ë¶€ë¶„ì„ ë³´ë©´ ì²˜ìŒë³´ëŠ” `provider` íƒœê·¸ê°€ ë³´ì¸ë‹¤.  
ì•„ë˜ì—ì„œ ì•Œì•„ë³´ë„ë¡ í•˜ì.  
```xml
AndroidManifest.xml: 26

...

<activity
            android:name=".FlagEighteenActivity"
            android:exported="true"
            android:label="@string/title_activity_flag_eighteen"
            android:theme="@style/AppTheme.NoActionBar" />

        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="b3nac.injuredandroid.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>
```
{: file='AndroidManifest.xml'}
<br/>

## File Providerë€?
***
ì•ˆì „í•œ íŒŒì¼ ê³µìœ ë¥¼ í•´ë„ë¡ ë„ì™€ì£¼ëŠ” ê²ƒì´ë‹¤. ì´ë¥¼ ì´ìš©í•˜ë©´ `file://` ëŒ€ì‹ ì— `content://` í˜•íƒœì˜ schemeì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ë° ì„ì‹œì ìœ¼ë¡œ íŒŒì¼ì— ëŒ€í•œ ê¶Œí•œì„ ë¶€ì—¬í•˜ëŠ” ê²ƒì´ë‹¤.  
ìœ„ì˜ Manifest íŒŒì¼ì—ì„œ `grantUriPermissions`ëŠ” ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„ìœ¼ë¡œ í•´ë‹¹ ê²½ë¡œì˜ íŒŒì¼ì„ ì½ê³ , ì“¸ ìˆ˜ ìˆë„ë¡ ì„¤ì •í•´ì£¼ëŠ” ë¶€ë¶„ì´ë‹¤.  
`<meta-data />` ì»´í¬ë„ŒíŠ¸ ì—ì„œëŠ” file pathì— ëŒ€í•œ ì„¤ì •ì„ í•˜ê²Œ ë˜ëŠ”ë° ì•„ë˜ì™€ ê°™ì´ `resource/res/xml/file_paths.xml`ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë‹¤. `<files-path />`ì˜ ê²½ìš° ë””í´íŠ¸ëŠ” `/data/data/<package_name>/files`ì´ë‹¤.  
```xml
<?xml version ="1.0" encoding ="utf-8"?>
<paths xmlns:android="http://schemas.android.com/apk/res/android">
    <files-path name="files" path="/" />
</paths>
```
{: file='file_paths.xml'}
<br/>

ê²°êµ­ì€ ì•„ë˜ì™€ ê°™ì´ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ë° <u>file schemeì„ ì“°ëŠ” ê²ƒê³¼ ë‹¤ë¥´ê²Œ ì ˆëŒ€ì ì¸ ê²½ë¡œë¥¼ í¬í•¨í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— file schemeì„ ì¨ì„œ ì ˆëŒ€ê²½ë¡œë¥¼ ë…¸ì¶œì‹œí‚¤ëŠ” ê²ƒ ë³´ë‹¤ ì•ˆì „í•  ìˆ˜ ìˆë‹¤.</u>  
```text
content://b3nac.injuredandroid.fileprovider/files/test
```
<br/>

ê·¸ë˜ì„œ ì´ ë¬¸ì œ ê°™ì€ ê²½ìš°ëŠ” ì—‘í‹°ë¹„í‹°ê°€ `exported=â€trueâ€`ë¡œ ì„¤ì •ë˜ì–´ìˆê¸° ë•Œë¬¸ì— poc ì•±ì„ ë§Œë“¤ì–´ì„œ ì ‘ê·¼ì„ í•  ìˆ˜ë„ ìˆê³  ë˜ëŠ” `frida`ë¥¼ ì´ìš©í•˜ì—¬ í’€ ìˆ˜ ìˆë‹¤. í•˜ì§€ë§Œ êµ³ì´ ì´ë ‡ê²Œ ì•ˆí•´ë„ ë£¨íŒ…ëœ ê¸°ê¸°ì—ì„œëŠ” ì•±ì˜ ë””ë ‰í† ë¦¬ì— ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ëˆˆì¹˜ ê» í’€ ìˆ˜ë„?  
<br/>

# ì´í‰
***
ì´ë ‡ê²Œ ëª¨ë“  ë¬¸ì œë¥¼ í’€ì–´ë³´ì•˜ëŠ”ë° 14, 16, 17ë²ˆì€ ë¹ ì ¸ìˆë‹¤. ê·¸ ì´ìœ ëŠ” `https://b3nac.com` ì´ ì‚¬ì´íŠ¸ê°€ ì§€ê¸ˆì€ ì •ìƒì ìœ¼ë¡œ í˜¸ìŠ¤íŒ…ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ì´ì™€ ê´€ë ¨ëœ ë¬¸ì œëŠ” í’€ ìˆ˜ ì—†ì—ˆë‹¤.ğŸ™‚ ê¸°ë³¸ì ìœ¼ë¡œ ë‚œë…í™”ê°€ ì¡°ê¸ˆ ë˜ì–´ìˆê¸° ë•Œë¬¸ì— ì‹œê°„ì€ ê±¸ë¦´ì§€ë¼ë„ ì•ˆë“œë¡œì´ë“œì— ëŒ€í•´ì„œ ì¡°ê¸ˆ ë” ì•Œê²Œëœ ëŠë‚Œì„ ë°›ê³  ì‹¶ë‹¤ë©´ í•œ ë²ˆ í’€ì–´ë³´ëŠ” ê²ƒì„ ì¶”ì²œí•œë‹¤.  
<br/>

# Reference
***
- [https://developer.android.com/reference/android/content/Intent](https://developer.android.com/reference/android/content/Intent)
- [https://mond-al.github.io/cachefile-share](https://mond-al.github.io/cachefile-share)
- [https://github.com/B3nac/InjuredAndroid/blob/master/InjuredAndroid-FlagWalkthroughs.md](https://github.com/B3nac/InjuredAndroid/blob/master/InjuredAndroid-FlagWalkthroughs.md)