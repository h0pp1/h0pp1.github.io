---
title: '[TIL] CVE-2022-22978 : Authorization Bypass in RegexRequestMatcher'
author: hoppi
date: 2023-05-06 19:02:00 + 0000
categories: [Web]
tags: [web, spring, cve-2022-22978, regex]
---

`LINE CTF 2023`ì— ë‚˜ì™”ë˜ `safenote` ë¬¸ì œì—ì„œ ì‚¬ìš©ëœ `CVE-2022-22978`ì— ëŒ€í•´ì„œ ê°„ë‹¨í•˜ê²Œ ì´ì•¼ê¸° í•´ë³¼ë ¤ê³  í•©ë‹ˆë‹¤. ëª°ëëŠ”ë° í•´ë‹¹ ì·¨ì•½ì ì€ `LINE`ì—ì„œ ë°œê²¬í•œ CVEì˜€ìŠµë‹ˆë‹¤.ğŸ«¢  
<br/>

# CVE-2022-22978
***
## ì˜í–¥ë°›ëŠ” ë²„ì „
***
ì˜í–¥ë°›ëŠ” spring security ë²„ì „ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.  
![affected](../../../assets/img/2023-05-06/affected.png){: w="700" h="350" }  
<br/>

## ë¶„ì„
***
í•´ë‹¹ ì·¨ì•½ì ì´ íŒ¨ì¹˜ëœ [commit](https://github.com/spring-projects/spring-security/commit/70863952aeb9733499027714d38821db05654856)ë¶€ë¶„ì„ ë³´ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤. `Pattern` í´ë˜ìŠ¤ëŠ” `java.utils.regex` íŒ¨í‚¤ì§€ì— ìˆëŠ” íŒ¨í„´ ê´€ë ¨ í´ë˜ìŠ¤ì…ë‹ˆë‹¤. ì •ê·œ í‘œí˜„ì‹ ì—ì„œ ì“°ì´ëŠ” `.`ìœ¼ë¡œ ë¬¸ìì—´ ë§¤ì¹­ì„ í‘œí˜„í•  ë•Œ, `Pattern.DOTALL`í”Œë ˆê·¸ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ì¡´ì— `CRLF(\r\n)`ì™€ ë§¤ì¹­ë˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ í•´ê²°í•œ ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤.
![commit](../../../assets/img/2023-05-06/commit.png){: w="800" h="400" }  
<br/>

ê°„ë‹¨í•œ ì˜ˆì‹œë¥¼ í†µí•´ì„œ ì‚´í´ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ `Pattern.DOTALL` í”Œë˜ê·¸ë¥¼ ì‚¬ìš©í•˜ë©´ `\r`ë‚˜ `\n`ë„ ë§¤ì¹­ì´ ë©ë‹ˆë‹¤.  
```java
import java.util.regex.Pattern;
import java.util.regex.Matcher;

class TestRegex {
    public static void main(String[] args) {
      String pattern = "A.B";
      String input = "A\nB";

      Pattern p1 = Pattern.compile(pattern, Pattern.DOTALL);
      Pattern p2 = Pattern.compile(pattern);
      Matcher m1 = p1.matcher(input);
      Matcher m2 = p2.matcher(input);

      System.out.println(m1.matches()); // true
      System.out.println(m2.matches()); // false
    }
}
```
{: file="TestRegex.java"}
<br/>

## SafeNote ë¬¸ì œì—ì„œ
***
ìŠ¤í”„ë§ì—ì„œ ë³´í†µ URL íŒ¨í„´ ì •ì˜í•  ë•Œ, `antMatchers`ë¥¼ í†µí•´ `Ant-Style`íŒ¨í„´ì„ ì‚¬ìš©í•˜ì§€ë§Œ `SecurityConfig` í´ë˜ìŠ¤ë¥¼ ë³´ë©´ ì¤‘ê°„ì— `/api/admin`ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ë“¤ì€ `regexMatchers`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.    
![security_config](../../../assets/img/2023-05-06/security_config.png){: w="700" h="350" }  
<br/>

`/api/admin`ì´ `RequestMapping`ë˜ëŠ” `/key/{id}` ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ì¡°ê±´ì„ í†µê³¼í•˜ë©´ `application.properties`íŒŒì¼ì—ì„œ í•˜ë“œì½”ë”©ëœ `jwt.secret-key`ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. ë”°ë¼ì„œ ì´ ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬ `/api/admin/key/%0a`ë¡œ ìš”ì²­ì„ ë³´ë‚´ ê¶Œí•œì„ ìš°íšŒí•˜ì—¬ adminì˜ `jwt`ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.(ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸í–ˆê¸° ë•Œë¬¸ì— `XXX...`ë¡œ í‘œì‹œë©ë‹ˆë‹¤)  
![secret](../../../assets/img/2023-05-06/secret.png){: w="700" h="350" }  
<br/>

![local](../../../assets/img/2023-05-06/local.png){: w="700" h="350" }  
<br/>

# Reference
***
- [https://www.youtube.com/watch?v=3OAl0TLBrSk](https://www.youtube.com/watch?v=3OAl0TLBrSk)
- [https://nosec.org/home/detail/5006.html#&gid=1&pid=1](https://nosec.org/home/detail/5006.html#&gid=1&pid=1)
- [https://spring.io/security/cve-2022-22978](https://spring.io/security/cve-2022-22978)