---
title: '[Hackthebox] SAW'
author: hoppi
date: 2023-01-04 19:28:00 + 0000
categories: [Mobile, Reversing]
tags: [mobile, reversing, hackthebox]
---

ì˜ˆì „ì— í’€ì—ˆë˜ ë¬¸ì œì¸ë° ì¬ë°Œì—ˆë˜ ë¬¸ì œì—¬ì„œ ì—¬ê¸°ì— ì˜¬ë ¤ë³¸ë‹¤ã…‹ã…‹ ëª¨ë°”ì¼ ë¬¸ì œê°€ ë§ì´ ìˆìœ¼ë©´ ì¢‹ê² ëŠ”ë°... ë§ì´ ì—†ì–´ì„œ ì•„ì‰½ë‹¤ğŸ¥²

**í‚¤ì›Œë“œ: Mobile, Reversing**  

![description](../../../assets/img/2023-01-04/2023-01-04-description.png){: w="600" h="300" }  
<br/>

# ì½”ë“œ ë¶„ì„
***
ë¬¸ì œ apkíŒŒì¼ì„ ì—ë®¬ì— ì„¤ì¹˜í•˜ê³  ì‹¤í–‰ì„ í–ˆì„ ë•Œ ì•„ë¬´ëŸ° ë°˜ì‘ì´ ì—†ì—ˆë‹¤. ë”°ë¼ì„œ jadxë¥¼ ì´ìš©í•˜ì—¬ ì½”ë“œë¥¼ ì‚´í´ë³´ì•˜ë‹¤. (Android 10.0 ì´ìƒì´ì—ˆê¸°ë•Œë¬¸ì— ì—ë®¬ë¡œ ëŒë ¸ë‹¤.)  
`onCreate` í•¨ìˆ˜ì˜ 31Lì„ ë³´ë©´ `getExtras` í•´ì£¼ëŠ” ë¶€ë¶„ì´ ìˆëŠ”ë° ì–´ë””ì—ë„ `putExtras`ë¥¼ í•˜ëŠ” ëª¨ìŠµì€ ë³´ì´ì§€ ì•ŠëŠ”ë‹¤. ë”°ë¼ì„œ extrasëŠ” nullë¡œ ìœ ì¶”ê°€ ë˜ê³  ë°”ë¡œ êº¼ì§€ëŠ” ì´ìœ ë¥¼ ì•Œ ìˆ˜ ìˆì—ˆë‹¤. ë˜í•œ 34Lì„ ë³´ë©´ open:sesameì˜ key-value í˜•íƒœë¡œ ì „ë‹¬í•´ì•¼í•¨ì„ ì•Œ ìˆ˜ ìˆë‹¤.  
![oncreate](../../../assets/img/2023-01-04/2023-01-04-oncreate.png){: w="800" h="400" }  
<br/>

> putExtra í•¨ìˆ˜ëŠ” ì•¡í‹°ë¹„í‹° ê°„ ê°’ì„ ì£¼ê³  ë°›ëŠ”ë° ì£¼ë¡œ ì“°ì¸ë‹¤. ì•¡í‹°ë¹„í‹° ê°„ì— ì´ë™í•˜ê¸° ìœ„í•´ì„œëŠ” Intentë¡œ ì•¡í‹°ë¹„í‹° ì´ë™ì„ í•˜ê²Œëœë‹¤. ì´ ë•Œ ì´ì „ ì•¡í‹°ë¹„í‹°ì—ì„œ ì–´ë–¤ ê°’ì„ ë„˜ê¸°ê³  ì‹¶ì„ ë•Œ ì“°ë©´ëœë‹¤.
{: .prompt-info }  
<br/>

ì•„ë˜ì˜ í›„í‚¹ì½”ë“œë¥¼ ì´ìš©í•˜ì—¬ ì•±ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ë„ë¡ í•œë‹¤.  
```javascript
function hookGetIntent(){
    var cls = Java.use('android.app.Activity');

    cls.getIntent.implementation = function(){
        
        return this.getIntent().putExtra('open','sesame');
    }
}
```
<br/>

ë¬¸ì œë¥¼ í’€ê³ ë‚˜ì„œ êµ¬ê¸€ë§ì„ í†µí•´ ë‹¤ìŒê³¼ ê°™ì´ am(Activity Manager) ëª…ë ¹ì–´ë¡œë„ ë°ì´í„°ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆë‹¤.  
```shell
am start -a android.intent.action.MAIN --es 'open' 'sesame' -n com.stego.saw/.MainActivity
```
{: file="adb shell"}  
<br/>

ì•„ë¬´íŠ¼ ì´ë ‡ê²Œ ì•±ì´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ì´ ëœë‹¤.  
![showup](../../../assets/img/2023-01-04/2023-01-04-showup.png){: w="200" h="100" }  
<br/>

í•˜ì§€ë§Œ `Click meâ€¦` ë¥¼ ëˆŒëŸ¬ë³´ë©´ ì•±ì´ ê°‘ìê¸° ì¢…ë£Œê°€ ëœë‹¤. logcatì„ í™•ì¸í•´ë³´ë©´ ì•„ë˜ì™€ ê°™ì´  `permission denied`ê°€ ëœ¬ê²ƒì„ í™•ì¸í•   ìˆ˜ ìˆë‹¤. <u>í•´ê²° ë°©ë²•ì€ ì•± ì •ë³´ì—ì„œ 'ë‹¤ë¥¸ ì•± ìœ„ì— ê·¸ë¦¬ê¸°' ê¶Œí•œì„ í—ˆìš©í•˜ë©´ ëœë‹¤.</u>  
![logcat](../../../assets/img/2023-01-04/2023-01-04-logcat.png){: w="800" h="400" }  
<br/>

ê·¸ëŸ¬ë©´ ì´ë ‡ê²Œ ê°’ì„ ì…ë ¥í•  ìˆ˜ ìˆëŠ” ë‹¤ì´ì–¼ë¡œê·¸ê°€ ëœ¬ë‹¤.  
![dialog](../../../assets/img/2023-01-04/2023-01-04-dialog.png){: w="200" h="100" }  
<br/>

ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ ë„ìš°ëŠ” `alert` í•¨ìˆ˜ë¥¼ ë³´ë©´ 69Lì—ì„œ ì‚¬ìš©ìì˜ ì…ë ¥ê°’ì„ `this.answer`ì— ì €ì¥í•˜ê³  ê·¸ ê°’ì„ `a` í•¨ìˆ˜ì˜ ì¸ìê°’ìœ¼ë¡œ ì „ë‹¬í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.  
![alert](../../../assets/img/2023-01-04/2023-01-04-alert.png){: w="800" h="400" }  
<br/>

`a` í•¨ìˆ˜ê°€ ì„ ì–¸ë˜ì–´ìˆëŠ” ê³³ìœ¼ë¡œ ê°€ë³´ë©´ `native` í‚¤ì›Œë“œê°€ ìˆëŠ” ê²ƒìœ¼ë¡œ ë³´ì•„ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ë¡œë”©í•˜ëŠ” í•¨ìˆ˜ì´ê³ , ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ë¦„ì´ `default`ì™€ ê´€ë ¨ìˆëŠ” ê²ƒì„ ìœ ì¶”í•  ìˆ˜ ìˆë‹¤.  
![native](../../../assets/img/2023-01-04/2023-01-04-native.png){: w="600" h="300" }  
<br/>

# libdefault.so ë¶„ì„
***
idaë¥¼ í†µí•´ì„œ `libdefault.so`ë¥¼ ì—´ì–´ë³´ë©´ ì‹¬ë³¼ì´ ì œê±°ë˜ì–´ìˆì§€ ì•Šê¸° ë•Œë¬¸ì— `a` í•¨ìˆ˜ë¥¼ ì‰½ê²Œ ì°¾ì„ ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  ì´ê³³ì—ì„œ `_Z1aP7_JNIEnvP8_1` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.  
```c
__int64 __fastcall a(__int64 a1, __int64 a2, __int64 a3, __int64 a4)
{
  __int64 v4; // x21
  __int64 v5; // x19
  __int64 v6; // x20
  const char *v7; // x22
  const char *v8; // x0

  v4 = a3;
  v5 = a4;
  v6 = a1;
  v7 = (const char *)(*(__int64 (**)(void))(*(_QWORD *)a1 + 1352LL))();
  v8 = (const char *)(*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(*(_QWORD *)v6 + 1352LL))(v6, v5, 0LL);
  _Z1aP7_JNIEnvP8_1(v7, v8);
  (*(void (__fastcall **)(__int64, __int64, const char *))(*(_QWORD *)v6 + 1360LL))(v6, v4, v7);
  return (*(__int64 (__fastcall **)(__int64, const char *))(*(_QWORD *)v6 + 1336LL))(v6, v7);
}
```
{: file="function a()"}  
<br/>

`_Z1aP7_JNIEnvP8_1` í•¨ìˆ˜ë¡œ ê°€ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ì¸ìë¡œ ì „ë‹¬ëœ ê°’ê³¼ íŠ¹ì • ë°”ì´íŠ¸ë¥¼ xor ì—°ì‚°ì„ í•˜ëŠ” ë¶€ë¶„ì´ ì¡´ì¬í•˜ê³  ì €ì¥ëœ ë°”ì´íŠ¸ì™€ ë§ì§€ ì•Šìœ¼ë©´ result ë³€ìˆ˜ì— 1ì„ ì €ì¥í•˜ê³  ë¦¬í„´ í•´ë²„ë¦¬ëŠ” ë¶„ê¸°ê°€ ì¡´ì¬í•œë‹¤.  
![z1](../../../assets/img/2023-01-04/2023-01-04-z1.png){: w="600" h="300" }  
<br/>

ë§Œì•½ì— ë§ë‹¤ë©´ `fopen` í•¨ìˆ˜ë¥¼ í†µí•´ì„œ ì–´ë–¤ íŒŒì¼ì„ ì—´ê³  `fput` í•¨ìˆ˜ë¥¼ í†µí•´ì„œ ì–´ë–¤ ë‚´ìš©ì„ ì“´ë‹¤.  
![z2](../../../assets/img/2023-01-04/2023-01-04-z2.png){: w="600" h="300" }  
<br/>

# Get Flag
***
`_Z1aP7_JNIEnvP8_1` í•¨ìˆ˜ì—ì„œ ê²€ì‚¬í•˜ê³ ì í•˜ëŠ” ë¬¸ìì—´ì´ ì–´ë–¤ ê²ƒì¸ì§€ ì•Œê¸° ìœ„í•´ì„œ xor ì—°ì‚°ì˜ íŠ¹ì„±ì„ ì´ìš©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì€ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§¤ ìˆ˜ ìˆë‹¤.  
```python
info = lambda x: print(f'[+] {x}')

key_array = [0xa, 0xb, 0x18, 0xf, 0x5e, 0x31, 0xc, 0xf]
result_array = [0x6c, 0x67, 0x28, 0x6e, 0x2a, 0x58, 0x62, 0x68]
input = ''

for i in range(len(key_array)):
    tmp = chr(key_array[i] ^ result_array[i])
    input += tmp
    
info(f'Input ==> {input}')
```
<br/>

ìœ„ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ `fl0ating` ì´ë¼ëŠ” ë¬¸ìì—´ì´ ë‚˜ì˜¨ë‹¤. ë˜í•œ ì–´ëŠ ìœ„ì¹˜ì— íŒŒì¼ì„ ì“°ëŠ”ì§€ ì•Œê¸°ìœ„í•´ì„œ `_Z1aP7_JNIEnvP8_1` í•¨ìˆ˜ë¥¼ í›„í‚¹í•œë‹¤.  
```javascript
function libDefault() {
    var lib_addr=Module.findBaseAddress('libdefault.so');
    const OFFSET = 0xab4
    
    Interceptor.attach(ptr(lib_addr).add(OFFSET), {
        
        onEnter: function (args) { 
            console.log(`[+] Enter!!`)
            console.log(`[+] ${args[0].readUtf8String()}`);
            console.log(`[+] ${args[1].readUtf8String()}`);
        }, 
        onLeave: function (retval) {
    
            console.log(`[+] ${retval.toString()}`);
        } 
    }); 
}
```
<br/>

`fl0ating`ì„ ì…ë ¥í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ê²½ë¡œëŠ” `/data/user/0/com.stego.saw/`ì„ì„ ì•Œ ìˆ˜ ìˆë‹¤.  
![path](../../../assets/img/2023-01-04/2023-01-04-path.png){: w="600" h="300" }  
<br/>

í•´ë‹¹ ê²½ë¡œì— ë“¤ì–´ê°€ì„œ ìƒì„±ëœ h íŒŒì¼ì„ í™•ì¸í•´ë³´ë©´ í”Œë ˆê·¸ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.  
![flag](../../../assets/img/2023-01-04/2023-01-04-flag.png){: w="800" h="400" }  
<br/>

# Referece
***
- [https://dpdpwl.tistory.com/22](https://dpdpwl.tistory.com/22)
- [https://tjandroid.blogspot.com/2017/05/adb.html](https://tjandroid.blogspot.com/2017/05/adb.html)